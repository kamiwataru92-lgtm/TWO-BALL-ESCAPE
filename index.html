<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta charset="UTF-8">
<title>TWO BALL ESCAPE</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #111;
  overflow: hidden;
}

canvas {
  display: block;
}
</style>
</head>

<body style="touch-action:none;">
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

const joystick = {
  baseX: 0,
  baseY: 0,
  stickX: 0,
  stickY: 0,
  radius: 50,
  active: false
};

function resizeCanvas() {
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

  joystick.baseX = canvas.width / 2;
  joystick.baseY = canvas.height - 120;
  joystick.stickX = joystick.baseX;
  joystick.stickY = joystick.baseY;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// ===== プレイヤー =====
const player = {
  x: canvas.width / 2,
  y: canvas.height / 2,
  r: 10,
  speed: 4
};

// ===== 敵 =====
const enemies = [
  { x: 100, y: 100, r: 12, speed: 3.5 },
  { x: 700, y: 500, r: 12, speed: 5 }
];

// ===== 入力 =====
const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// タッチ操作
if (isTouchDevice) {
canvas.addEventListener("touchstart", () => joystick.active = true);

canvas.addEventListener("touchmove", e => {
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches[0];

  let dx = touch.clientX - rect.left - joystick.baseX;
  let dy = touch.clientY - rect.top - joystick.baseY;

  const dist = Math.hypot(dx, dy);

  if (dist > joystick.radius) {
    dx = dx / dist * joystick.radius;
    dy = dy / dist * joystick.radius;
  }

  joystick.stickX = joystick.baseX + dx;
  joystick.stickY = joystick.baseY + dy;
});

canvas.addEventListener("touchend", () => {
  joystick.active = false;
  joystick.stickX = joystick.baseX;
  joystick.stickY = joystick.baseY;
});
}

// ===== 時間 =====
let startTime = Date.now();
let gameOver = false;

// ===== 更新 =====
function update() {
  if (gameOver) return;

  // キーボード移動
  if (keys["w"] || keys["ArrowUp"]) player.y -= player.speed;
  if (keys["s"] || keys["ArrowDown"]) player.y += player.speed;
  if (keys["a"] || keys["ArrowLeft"]) player.x -= player.speed;
  if (keys["d"] || keys["ArrowRight"]) player.x += player.speed;

  // ジョイスティック移動
  if (joystick.active) {
    const dx = joystick.stickX - joystick.baseX;
    const dy = joystick.stickY - joystick.baseY;
    player.x += dx * 0.1;
    player.y += dy * 0.1;
  }

  // 画面外防止
  player.x = Math.max(player.r, Math.min(canvas.width - player.r, player.x));
  player.y = Math.max(player.r, Math.min(canvas.height - player.r, player.y));

  // ===== 敵AI（左右から回り込み） =====
  enemies.forEach((enemy, index) => {
    const dx = player.x - enemy.x;
    const dy = player.y - enemy.y;
    const dist = Math.hypot(dx, dy);

    if (dist === 0) return;

    const dirX = dx / dist;
    const dirY = dy / dist;

    let perpX, perpY;

    if (index === 0) {
      perpX = -dirY;  // 左回り
      perpY = dirX;
    } else {
      perpX = dirY;   // 右回り
      perpY = -dirX;
    }

    const chaseWeight = 0.6;
    const circleWeight = 0.8;

    const moveX = dirX * chaseWeight + perpX * circleWeight;
    const moveY = dirY * chaseWeight + perpY * circleWeight;

    enemy.x += moveX * enemy.speed;
    enemy.y += moveY * enemy.speed;

    if (dist < player.r + enemy.r) {
      gameOver = true;
    }
  });
}

// ===== 描画 =====
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // プレイヤー
  ctx.fillStyle = "cyan";
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.r, 0, Math.PI * 2);
  ctx.fill();

  // 敵
  enemies.forEach(enemy => {
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(enemy.x, enemy.y, enemy.r, 0, Math.PI * 2);
    ctx.fill();
  });

  // タイム表示
  ctx.fillStyle = "white";
  ctx.font = "20px sans-serif";
  const time = ((Date.now() - startTime) / 1000).toFixed(1);
  ctx.fillText(`Time: ${time}s`, 10, 25);

  if (gameOver) {
    ctx.fillStyle = "yellow";
    ctx.font = "40px sans-serif";
    ctx.fillText("GAME OVER", canvas.width/2 - 120, canvas.height/2);
  }

  // ジョイスティック描画
if (isTouchDevice) {
  ctx.globalAlpha = 0.4;

  ctx.beginPath();
  ctx.arc(joystick.baseX, joystick.baseY, joystick.radius, 0, Math.PI * 2);
  ctx.fillStyle = "gray";
  ctx.fill();

  ctx.beginPath();
  ctx.arc(joystick.stickX, joystick.stickY, 25, 0, Math.PI * 2);
  ctx.fillStyle = "white";
  ctx.fill();

  ctx.globalAlpha = 1;
}

}

// ===== ループ =====
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
